<!-- index.html -->

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />

    <script>
      (function () {
        // localStorageì—ì„œ ì €ì¥ëœ í…Œë§ˆë¥¼ í™•ì¸
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          // <html> íƒœê·¸ì— data-theme="dark" ì†ì„± ì¶”ê°€
          document.documentElement.dataset.theme = "dark";
        } else {
          // ê¸°ë³¸ê°’ì€ 'light'
          document.documentElement.dataset.theme = "light";
        }
      })();
    </script>

    <title>WORKBASE</title>
    <!-- CSS -->
    <link rel="stylesheet" href="../styles/common.css" />
    <link rel="stylesheet" href="../styles/sidebar.css" />
    <link rel="stylesheet" href="../styles/todo.css" />
    <link rel="stylesheet" href="../styles/tooltip.css" />
    <link rel="stylesheet" href="../styles/window-control.css" />
    <link rel="stylesheet" href="../styles/context-menu.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css"
    />
    
    <!-- Firebase SDKë¥¼ CDNì—ì„œ ë¡œë“œ (ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ IndexedDB ì ‘ê·¼ ê°€ëŠ¥) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script>
      // Firebase ì´ˆê¸°í™” (ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ì–´ IndexedDB ì ‘ê·¼ ê°€ëŠ¥)
      const firebaseConfig = {
        apiKey: "AIzaSyCwkXiJRp1DHoiv1IWnR42Y9xI5IE0_2uE",
        authDomain: "workbear-aaecb.firebaseapp.com",
        databaseURL: "https://workbear-aaecb-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "workbear-aaecb",
        storageBucket: "workbear-aaecb.appspot.com",
        messagingSenderId: "744723448261",
        appId: "1:744723448261:web:897a77a06e481f3c750bac",
      };
      
      // Firebase ì´ˆê¸°í™”
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      
      // Local persistence ì„¤ì •
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
        console.log("âœ… Firebase Auth (ë Œë”ëŸ¬) persistenceê°€ localë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }).catch((error) => {
        console.error("âŒ Firebase Auth persistence ì„¤ì • ì‹¤íŒ¨:", error);
      });
      
      // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
      window.firebaseAuth = auth;
      console.log("ğŸ”¥ Firebaseê°€ ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    </script>
  </head>

  <body>
    <div id="window-control"></div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="main">
      <div id="sidebar"></div>
      <div id="todo-today"></div>
    </div>

    <div class="context-menu" id="user-context-menu">
      <div class="context-body">
        <button class="context-item">
          <svg class="icon">
            <use href="#icon-user"></use>
          </svg>
          <span>ë‚´ ì •ë³´</span>
        </button>
        <button class="context-item" id="logout-button">
          <svg class="icon">
            <use href="#icon-logout"></use>
          </svg>
          <span>ë¡œê·¸ì•„ì›ƒ</span>
        </button>
      </div>
    </div>

    <script src="../js/sidebar.js"></script>
    <script src="../js/tooltip.js"></script>
    <script src="../js/context-menu.js"></script>

    <script>
      // 1. ê° ì»´í¬ë„ŒíŠ¸ ë¡œë“œë¥¼ Promiseë¡œ ì •ì˜
      const loadWindowControl = fetch("../html/component/window-control.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("window-control").innerHTML = data;
        });

      const loadSidebar = fetch("../html/component/sidebar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("sidebar").innerHTML = data;
        });

      const loadTodoToday = fetch("../html/component/todo-today.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("todo-today").innerHTML = data;
        });

      const loadIcons = fetch("../../../assets/icons/icons.svg")
        .then((res) => res.text())
        .then((data) => document.body.insertAdjacentHTML("afterbegin", data));

      // 2. ëª¨ë“  Promiseê°€ ì™„ë£Œë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¼
      Promise.all([loadWindowControl, loadSidebar, loadTodoToday, loadIcons])
        .then(() => {
          console.log("âœ… All components and icons loaded.");

          // 3. ëª¨ë“  HTMLì´ ë¡œë“œëœ í›„, í•„ìš”í•œ ìŠ¤í¬ë¦½íŠ¸ì™€ ì•±ì„ ì´ˆê¸°í™”
          // âœ… window-control.js ë¡œë“œ
          const script = document.createElement("script");
          script.src = "../js/window-control.js";
          document.body.appendChild(script);

          // âœ… ì‚¬ì´ë“œë°”ì˜ í”„ë¡œí•„ ë²„íŠ¼ì— data- ì†ì„± ë™ì  ì¶”ê°€
          const sidebarContainer = document.getElementById("sidebar");
          let userProfileButton = null;

          if (sidebarContainer) {
            userProfileButton = sidebarContainer.querySelector(
              ".user-profile" // .more ëŒ€ì‹  div ì „ì²´
            );
          }

          if (userProfileButton) {
            userProfileButton.dataset.contextMenuTarget = "user-context-menu";
            console.log("âœ… User profile (div) context menu trigger set.");
          } else {
            console.warn("âš ï¸ Could not find .user-profile div");
          }

          // --- [ê°œì„ ] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë Œë”ëŸ¬ Firebase ì‚¬ìš©) ---
          const logoutButton = document.getElementById("logout-button");
          if (logoutButton) {
            logoutButton.addEventListener("click", async () => {
              console.log("ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ë¨");
              try {
                // ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì˜ Firebase Auth ì‚¬ìš©
                if (window.firebaseAuth) {
                  const auth = window.firebaseAuth;
                  await auth.signOut();
                  console.log("âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ (ë Œë”ëŸ¬). ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                  
                  // IPCë¥¼ í†µí•´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                  if (window.appAPI && window.appAPI.navigateToPage) {
                    window.appAPI.navigateToPage("login", { status: "loggedout" });
                  } else {
                    window.location.href = "./login.html?status=loggedout";
                  }
                } else if (window.appAPI && window.appAPI.signOut) {
                  // ë°±ì—…: preload.jsì˜ appAPI ì‚¬ìš©
                  const result = await window.appAPI.signOut();
                  if (result.ok) {
                    console.log("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    if (window.appAPI && window.appAPI.navigateToPage) {
                      window.appAPI.navigateToPage("login", { status: "loggedout" });
                    } else {
                      window.location.href = "./login.html?status=loggedout";
                    }
                  } else {
                    console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", result.error);
                    alert("ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + result.error);
                  }
                } else {
                  console.warn("Firebase Authë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                  window.location.href = "./login.html?status=loggedout";
                }
              } catch (e) {
                console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
              }
            });
          } else {
            console.warn(
              "âš ï¸ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼(#logout-button)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            );
          }
          // --- [ê°œì„  ë] ---

          // âœ… íˆ´íŒ, ì‚¬ì´ë“œë°”, ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ˆê¸°í™”
          initTooltip();

          if (typeof initContextMenus === "function") {
            initContextMenus(); // ğŸ‘ˆ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì €)
          } else {
            console.error("âš ï¸ initContextMenus is not defined.");
          }

          initializeSidebarApp(); // ğŸ‘ˆ ì‚¬ì´ë“œë°” ì•± ì´ˆê¸°í™”
        })
        .catch((err) => {
          console.error("Component loading failed:", err);
        });
    </script>
  </body>
</html>
