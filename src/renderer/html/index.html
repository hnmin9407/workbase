<!-- index.html -->

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />

    <script>
      (function () {
        // localStorageì—ì„œ ì €ì¥ëœ í…Œë§ˆë¥¼ í™•ì¸
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          // <html> íƒœê·¸ì— data-theme="dark" ì†ì„± ì¶”ê°€
          document.documentElement.dataset.theme = "dark";
        } else {
          // ê¸°ë³¸ê°’ì€ 'light'
          document.documentElement.dataset.theme = "light";
        }
      })();
    </script>

    <!-- [ìˆ˜ì •] FOUC(í™”ë©´ ê¹œë¹¡ì„) ë°©ì§€: í…Œë§ˆ ìŠ¤í¬ë¦½íŠ¸ ì§í›„ì— ë°°ê²½ìƒ‰ì„ ê°•ì œí•©ë‹ˆë‹¤. -->
    <style>
      html[data-theme="dark"] {
        background: #121212;
      }
    </style>

    <title>WORKBASE</title>
    <!-- CSS -->
    <link rel="stylesheet" href="../styles/common.css" />
    <link rel="stylesheet" href="../styles/sidebar.css" />
    <link rel="stylesheet" href="../styles/todo.css" />
    <link rel="stylesheet" href="../styles/tooltip.css" />
    <link rel="stylesheet" href="../styles/window-control.css" />
    <link rel="stylesheet" href="../styles/context-menu.css" />
    <link rel="stylesheet" href="../styles/opening.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css"
    />

    <!-- Firebase SDKë¥¼ CDNì—ì„œ ë¡œë“œ (package.json ë²„ì „ê³¼ ì¼ì¹˜ ê¶Œì¥) -->
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-database-compat.js"></script>
    <script>
      // Firebase ì´ˆê¸°í™” (ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ì–´ IndexedDB ì ‘ê·¼ ê°€ëŠ¥)
      const firebaseConfig = {
        apiKey: "AIzaSyCwkXiJRp1DHoiv1IWnR42Y9xI5IE0_2uE", // ë³´ì•ˆì„ ìœ„í•´ ë©”ì¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        authDomain: "workbear-aaecb.firebaseapp.com",
        databaseURL:
          "https://workbear-aaecb-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "workbear-aaecb",
        storageBucket: "workbear-aaecb.appspot.com",
        messagingSenderId: "744723448261",
        appId: "1:744723448261:web:897a77a06e481f3c750bac",
      };

      // Firebase ì´ˆê¸°í™”
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
      window.firebaseAuth = auth;
      console.log("ğŸ”¥ Firebaseê°€ ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    </script>
  </head>

  <body>
    <!--
    <div class="opening">
      <img src="../../../assets/image/logo.png" />
    </div>
  -->

    <!-- [ì¶”ê°€] í”„ë¡œì íŠ¸ ì¶”ê°€ íŒì—… -->
    <div class="popup-overlay" id="add-project-overlay">
      <div class="popup" id="add-project-popup">
        <span class="h1">í”„ë¡œì íŠ¸ ìƒì„±</span>
        <div class="popup-input-wrap">
          <span class="h2">í”„ë¡œì íŠ¸ ì´ë¦„</span>
          <input class="popup-input" id="project-name-input" />
        </div>
        <div class="button-wrap">
          <button class="cancel-button" id="cancel-project-button">ì·¨ì†Œ</button>
          <button class="confirm-button" id="confirm-project-button">
            ì¶”ê°€
          </button>
        </div>
      </div>
    </div>

    <!-- [ì¶”ê°€] í”„ë¡œì íŠ¸ ìˆ˜ì • íŒì—… -->
    <div class="popup-overlay" id="edit-project-overlay">
      <div class="popup" id="edit-project-popup">
        <span class="h1">í”„ë¡œì íŠ¸ ìˆ˜ì •</span>
        <div class="popup-input-wrap">
          <span class="h2">í”„ë¡œì íŠ¸ ì´ë¦„</span>
          <input class="popup-input" id="edit-project-name-input" />
        </div>
        <div class="button-wrap">
          <button class="cancel-button" id="cancel-edit-project-button">
            ì·¨ì†Œ
          </button>
          <button class="confirm-button" id="confirm-edit-project-button">
            ìˆ˜ì •
          </button>
        </div>
      </div>
    </div>

    <div id="window-control"></div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="main">
      <div id="sidebar"></div>
      <div id="todo-today"></div>
    </div>

    <div class="context-menu" id="user-context-menu">
      <div class="context-body">
        <button class="context-item">
          <svg class="icon">
            <use href="#icon-user"></use>
          </svg>
          <span>ë‚´ ì •ë³´</span>
        </button>
        <button class="context-item" id="logout-button">
          <svg class="icon">
            <use href="#icon-logout"></use>
          </svg>
          <span>ë¡œê·¸ì•„ì›ƒ</span>
        </button>
      </div>
    </div>

    <div class="context-menu" id="project-edit">
      <div class="context-body">
        <button class="context-item" id="pin-project-button">
          <svg class="icon">
            <use href="#icon-star"></use>
          </svg>
          <span>ê³ ì •</span>
        </button>
        <button class="context-item" id="edit-project-button">
          <svg class="icon">
            <use href="#icon-user"></use>
          </svg>
          <span>ìˆ˜ì •</span>
        </button>
        <button class="context-item" id="delete-project-button">
          <svg class="icon">
            <use href="#icon-logout"></use>
          </svg>
          <span>ì‚­ì œ</span>
        </button>
        <div class="line" style="margin: 2px 0"></div>
        <button class="context-item" id="move-up-button">
          <svg class="icon">
            <use href="#icon-up"></use>
          </svg>
          <span>ìœ„ë¡œ</span>
        </button>
        <button class="context-item" id="move-down-button">
          <svg class="icon">
            <use href="#icon-down"></use>
          </svg>
          <span>ì•„ë˜ë¡œ</span>
        </button>
      </div>
    </div>

    <!-- [ì¶”ê°€] ì•Œë¦¼ íŒì—… -->
    <div id="alert-popup" class="alert-popup">
      <div class="alert-content">
        <div class="left">
          <div class="alert-icon-wrapper" id="alert-icon-wrapper">
            <svg class="icon"><use id="alert-icon-use" href=""></use></svg>
          </div>
        </div>
        <div class="right">
          <div class="alert-title">ì•Œë¦¼</div>
          <div id="alert-message" class="alert-message"></div>
        </div>
      </div>
    </div>

    <script>
      // 1. ê° ì»´í¬ë„ŒíŠ¸ ë¡œë“œë¥¼ Promiseë¡œ ì •ì˜
      const loadWindowControl = fetch("../html/component/window-control.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("window-control").innerHTML = data;
        });

      const loadSidebar = fetch("../html/component/sidebar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("sidebar").innerHTML = data;
        });

      const loadTodoToday = fetch("../html/component/todo-today.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("todo-today").innerHTML = data;
        });

      const loadIcons = fetch("../../../assets/icons/icons.svg")
        .then((res) => res.text())
        .then((data) => document.body.insertAdjacentHTML("afterbegin", data));

      // 2. ëª¨ë“  Promiseê°€ ì™„ë£Œë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¼
      Promise.all([loadWindowControl, loadSidebar, loadTodoToday, loadIcons])
        .then(() => {
          // [ìˆ˜ì •] ëª¨ë“  HTMLì´ ë¡œë“œëœ í›„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
          const loadScript = (src) => {
            const script = document.createElement("script");
            script.src = src;
            document.body.appendChild(script);
            return new Promise((resolve) => (script.onload = resolve));
          };

          console.log("âœ… All components and icons loaded.");

          // âœ… [ì¶”ê°€] ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
          const openingScreen = document.querySelector(".opening");
          if (openingScreen) {
            openingScreen.classList.add("hide");
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.5s) í›„ì— display: none ì²˜ë¦¬
            setTimeout(() => {
              openingScreen.style.display = "none";
            }, 500);
          }

          // âœ… window-control.js ë¡œë“œ
          loadScript("../js/window-control.js");

          // [ìˆ˜ì •] ëª¨ë“  UI ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œê°€ ì™„ë£Œëœ í›„ ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
          Promise.all([
            loadScript("../js/tooltip.js"),
            loadScript("../js/context-menu.js"),
            loadScript("../js/alert-popup.js"),
            loadScript("../js/sidebar.js"),
          ]).then(() => {
            // âœ… íˆ´íŒ, ì‚¬ì´ë“œë°”, ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ˆê¸°í™”
            initTooltip();
            initAlertPopups();

            if (typeof initContextMenus === "function") {
              initContextMenus(); // ğŸ‘ˆ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì €)
            } else {
              console.error("âš ï¸ initContextMenus is not defined.");
            }

            initializeSidebarApp(); // ğŸ‘ˆ ì‚¬ì´ë“œë°” ì•± ì´ˆê¸°í™”
          });

          // âœ… ì‚¬ì´ë“œë°”ì˜ í”„ë¡œí•„ ë²„íŠ¼ì— data- ì†ì„± ë™ì  ì¶”ê°€
          const sidebarContainer = document.getElementById("sidebar");
          let userProfileButton = null;

          if (sidebarContainer) {
            userProfileButton = sidebarContainer.querySelector(
              ".user-profile" // .more ëŒ€ì‹  div ì „ì²´
            );
          }

          if (userProfileButton) {
            userProfileButton.dataset.contextMenuTarget = "user-context-menu";
            console.log("âœ… User profile (div) context menu trigger set.");
          } else {
            console.warn("âš ï¸ Could not find .user-profile div");
          }

          // --- [ê°œì„ ] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë Œë”ëŸ¬ Firebase ì‚¬ìš©) ---
          const logoutButton = document.getElementById("logout-button");
          if (logoutButton) {
            logoutButton.addEventListener("click", async () => {
              console.log("ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ë¨");
              try {
                // ë Œë”ëŸ¬ í”„ë¡œì„¸ìŠ¤ì˜ Firebase Auth ì‚¬ìš©
                if (window.firebaseAuth) {
                  const auth = window.firebaseAuth;
                  await auth.signOut();
                  console.log(
                    "âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ (ë Œë”ëŸ¬). ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤."
                  );

                  // IPCë¥¼ í†µí•´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                  if (window.appAPI && window.appAPI.navigateToPage) {
                    window.appAPI.navigateToPage("login", {
                      status: "loggedout",
                    });
                  } else {
                    window.location.href = "./login.html?status=loggedout";
                  }
                } else if (window.appAPI && window.appAPI.signOut) {
                  // ë°±ì—…: preload.jsì˜ appAPI ì‚¬ìš©
                  const result = await window.appAPI.signOut();
                  if (result.ok) {
                    console.log("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    if (window.appAPI && window.appAPI.navigateToPage) {
                      window.appAPI.navigateToPage("login", {
                        status: "loggedout",
                      });
                    } else {
                      window.location.href = "./login.html?status=loggedout";
                    }
                  } else {
                    console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", result.error);
                    alert("ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + result.error);
                  }
                } else {
                  console.warn("Firebase Authë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                  window.location.href = "./login.html?status=loggedout";
                }
              } catch (e) {
                console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
              }
            });
          } else {
            console.warn(
              "âš ï¸ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼(#logout-button)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            );
          }
          // --- [ê°œì„  ë] ---
        })
        .catch((err) => {
          console.error("Component loading failed:", err);
        });
    </script>
  </body>
</html>
